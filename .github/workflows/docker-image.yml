name: Edge via Tailscale (Private Domain)

on:
  workflow_dispatch:
    inputs:
      password:
        description: "HTTP Basic Auth password"
        required: true
        type: string
      custom_user:
        description: "Username"
        default: edgeuser
        type: string
      subdomain:
        description: "Subdomain (e.g. edge)"
        default: edge
        type: string

jobs:
  edge:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # -------------------------------------------------
      # 1. Install Tailscale
      # -------------------------------------------------
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          echo "Tailscale installed successfully."

      # -------------------------------------------------
      # 2. Fetch Auth Key & Authenticate (with retries)
      # -------------------------------------------------
      - name: Fetch Auth Key & Start Tailscale
        run: |
          # Fetch the auth key from your endpoint
          echo "Fetching auth key from https://sparkling-dew-5078.hacknomatrix.workers.dev/..."
          AUTHKEY=$(curl -s https://sparkling-dew-5078.hacknomatrix.workers.dev/)
          echo "Auth key fetched (first 20 chars): ${AUTHKEY:0:20}..."  # Partial log for debug
          
          if [ -z "$AUTHKEY" ] || [ "$AUTHKEY" = "null" ]; then
            echo "ERROR: Empty or invalid auth key!"
            exit 1
          fi

          # Start Tailscale with retries
          for attempt in {1..3}; do
            echo "Auth attempt $attempt/3..."
            sudo tailscale up \
              --authkey="$AUTHKEY" \
              --accept-dns=false \
              --accept-routes \
              --advertise-exit-node \
              --hostname=github-edge-${{ github.run_id }} \
              --quiet  # Suppress interactive prompts
            if [ $? -eq 0 ]; then
              echo "‚úÖ Tailscale authenticated!"
              break
            fi
            echo "Attempt $attempt failed, retrying in 10s..."
            sleep 10
          done

          # Verify connection
          echo "Tailscale status:"
          tailscale status
          echo "Tailscale IP:"
          tailscale ip --4
          TS_IP=$(tailscale ip --4 | head -n1)
          if [ -z "$TS_IP" ]; then
            echo "ERROR: No Tailscale IP assigned!"
            exit 1
          fi
          echo "‚úÖ Tailscale ready with IP: $TS_IP"

      # -------------------------------------------------
      # 3. Start MS Edge Container
      # -------------------------------------------------
      - name: Start MS Edge Container
        run: |
          docker run -d \
            --name msedge \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=Etc/UTC \
            -e CUSTOM_USER="${{ inputs.custom_user }}" \
            -e PASSWORD="${{ inputs.password }}" \
            -e HARDEN_DESKTOP=true \
            -e DISABLE_SUDO=true \
            -e DISABLE_TERMINALS=true \
            -e DISABLE_OPEN_TOOLS=true \
            -p 3000:3000 \
            -v ${{ runner.temp }}/config:/config \
            --shm-size=1gb \
            lscr.io/linuxserver/msedge:latest
          echo "Edge container started."

      # -------------------------------------------------
      # 4. Wait for Edge to be Ready
      # -------------------------------------------------
      - name: Wait for Edge
        run: |
          echo "Waiting for Edge desktop..."
          for i in {1..30}; do
            if docker logs msedge 2>&1 | grep -q "Selkies server listening"; then
              echo "‚úÖ Edge ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 5
          done
          echo "Edge logs (last 10 lines):"
          docker logs msedge | tail -n 10

      # -------------------------------------------------
      # 5. Enable Tailscale Funnel (HTTPS)
      # -------------------------------------------------
      - name: Enable Tailscale Funnel
        run: |
          # Extra wait for Tailscale stability
          sleep 20
          
          # Verify Tailscale is up
          until tailscale status > /dev/null 2>&1; do
            echo "Stabilizing Tailscale..."
            sleep 5
          done
          
          TS_IP=$(tailscale ip --4 | head -n1)
          echo "Current Tailscale IP: $TS_IP"

          # Enable Funnel: HTTPS on 443 ‚Üí localhost:3000 (Edge)
          echo "Enabling Funnel..."
          sudo tailscale funnel --bg --https=443:localhost:3000
          
          # Wait for Funnel to activate (poll status)
          for i in {1..12}; do  # 60s max
            if sudo tailscale funnel status | grep -q "running"; then
              echo "‚úÖ Funnel active!"
              break
            fi
            echo "Funnel warming up... ($i/12)"
            sleep 5
          done

          echo ""
          echo "=================================="
          echo "   üéâ PRIVATE EDGE BROWSER READY!"
          echo ""
          echo "   URL: https://${{ inputs.subdomain }}.browser.tools"
          echo "   Username: ${{ inputs.custom_user }}"
          echo "   Password: [the one you entered]"
          echo ""
          echo "   üì± Scan QR for mobile:"
          echo "   (Add this step if you want QR generation)"
          echo ""
          echo "   ‚ö†Ô∏è  Only accessible from your Tailscale devices!"
          echo "   üîí No public exposure. Dies after ~6h."
          echo "=================================="

      # -------------------------------------------------
      # 6. Keep Session Alive
      # -------------------------------------------------
      - name: Keep Alive (6 hours)
        run: |
          echo "Session active. Re-run workflow for a fresh one."
          sleep 21600  # 6 hours
