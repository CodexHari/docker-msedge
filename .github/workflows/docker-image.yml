name: Edge via Tailscale (Private Domain)

on:
  workflow_dispatch:
    inputs:
      password:
        description: "HTTP Basic Auth password"
        required: true
        type: string
      custom_user:
        description: "Username"
        default: edgeuser
        type: string
      subdomain:
        description: "Subdomain (e.g. edge)"
        default: edge
        type: string

jobs:
  edge:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          echo "Tailscale installed."

      - name: Start tailscaled & Authenticate
        run: |
          sudo systemctl start tailscaled
          sleep 5

          AUTHKEY=$(curl -s https://sparkling-dew-5078.hacknomatrix.workers.dev/)
          echo "Key: ${AUTHKEY:0:20}..."

          for i in {1..3}; do
            sudo tailscale up \
              --authkey="$AUTHKEY" \
              --accept-dns=false \
              --accept-routes \
              --advertise-exit-node \
              --hostname="github-edge-${{ github.run_id }}" \
              --force-reauth || true

            if tailscale status | grep -q "logged in"; then
              echo "Tailscale connected!"
              break
            fi
            sleep 10
          done

          tailscale status
          TS_IP=$(tailscale ip --4 | head -n1)
          echo "IP: $TS_IP"

      - name: Start MS Edge Container
        run: |
          docker run -d \
            --name msedge \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=Etc/UTC \
            -e CUSTOM_USER="${{ inputs.custom_user }}" \
            -e PASSWORD="${{ inputs.password }}" \
            -e HARDEN_DESKTOP=true \
            -e DISABLE_SUDO=true \
            -e DISABLE_TERMINALS=true \
            -e DISABLE_OPEN_TOOLS=true \
            -p 3000:3000 \
            -v ${{ runner.temp }}/config:/config \
            --shm-size=1gb \
            lscr.io/linuxserver/msedge:latest

      - name: Wait for Edge
        run: |
          for i in {1..30}; do
            if docker logs msedge 2>&1 | grep -q "Selkies server listening"; then
              echo "Edge ready!"
              break
            fi
            sleep 5
          done

      - name: Enable Tailscale Funnel (CORRECTED)
        run: |
          
          # CORRECT: --https=443 forwards to port 3000
          sudo tailscale funnel --bg --https=443 3000
          
          sleep 15

          echo ""
          echo "=================================="
          echo "   PRIVATE EDGE BROWSER IS LIVE!"
          echo ""
          echo "   https://${{ inputs.subdomain }}.browser.tools"
          echo "   Login: ${{ inputs.custom_user }} / [your password]"
          echo ""
          echo "   Only works on your Tailscale devices"
          echo "   No public exposure. Real TLS. Zero cost."
          echo "=================================="
          echo ""
          echo "   Tip: Add this to your phone's home screen!"

      - name: Keep Alive
        run: sleep 21600
