name: Edge via Tailscale (Private Domain)

on:
  workflow_dispatch:
    inputs:
      password:
        description: "HTTP Basic Auth password"
        required: true
        type: string
      custom_user:
        description: "Username"
        default: edgeuser
        type: string
      subdomain:
        description: "Subdomain (e.g. edge)"
        default: edge
        type: string

jobs:
  edge:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # -------------------------------------------------
      # 1. Install Tailscale
      # -------------------------------------------------
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          echo "Tailscale installed."

      # -------------------------------------------------
      # 2. Start tailscaled + Authenticate
      # -------------------------------------------------
      - name: Start tailscaled & Authenticate
        run: |
          # Start the daemon
          echo "Starting tailscaled..."
          sudo systemctl start tailscaled
          sleep 5

          # Fetch auth key
          echo "Fetching auth key..."
          AUTHKEY=$(curl -s https://sparkling-dew-5078.hacknomatrix.workers.dev/)
          echo "Key: ${AUTHKEY:0:20}..."

          if [ -z "$AUTHKEY" ] || [[ "$AUTHKEY" == "null" ]]; then
            echo "ERROR: Invalid auth key"
            exit 1
          fi

          # Authenticate with retry
          for i in {1..3}; do
            echo "Auth attempt $i..."
            sudo tailscale up \
              --authkey="$AUTHKEY" \
              --accept-dns=false \
              --accept-routes \
              --advertise-exit-node \
              --hostname="github-edge-${{ github.run_id }}" \
              --force-reauth || true

            # Check if connected
            if tailscale status | grep -q "logged in"; then
              echo "Tailscale connected!"
              break
            fi
            sleep 10
          done

          # Final check
          tailscale status
          TS_IP=$(tailscale ip --4 | head -n1)
          echo "IP: $TS_IP"
          if [ -z "$TS_IP" ]; then
            echo "ERROR: No IP"
            exit 1
          fi

      # -------------------------------------------------
      # 3. Start MS Edge
      # -------------------------------------------------
      - name: Start MS Edge Container
        run: |
          docker run -d \
            --name msedge \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=Etc/UTC \
            -e CUSTOM_USER="${{ inputs.custom_user }}" \
            -e PASSWORD="${{ inputs.password }}" \
            -e HARDEN_DESKTOP=true \
            -e DISABLE_SUDO=true \
            -e DISABLE_TERMINALS=true \
            -e DISABLE_OPEN_TOOLS=true \
            -p 3000:3000 \
            -v ${{ runner.temp }}/config:/config \
            --shm-size=1gb \
            lscr.io/linuxserver/msedge:latest

      # -------------------------------------------------
      # 4. Wait for Edge
      # -------------------------------------------------
      - name: Wait for Edge
        run: |
          for i in {1..30}; do
            if docker logs msedge 2>&1 | grep -q "Selkies server listening"; then
              echo "Edge ready!"
              break
            fi
            sleep 5
          done

      # -------------------------------------------------
      # 5. Enable Funnel
      # -------------------------------------------------
      - name: Enable Tailscale Funnel
        run: |
          sleep 15
          sudo tailscale funnel --bg --https=443:localhost:3000
          sleep 15

          echo ""
          echo "=================================="
          echo "   PRIVATE BROWSER READY!"
          echo "   https://${{ inputs.subdomain }}.browser.tools"
          echo "   Login: ${{ inputs.custom_user }} / [your password]"
          echo "   Only on Tailscale devices!"
          echo "=================================="

      # -------------------------------------------------
      # 6. Keep Alive
      # -------------------------------------------------
      - name: Keep Alive
        run: sleep 21600
