name: Edge via Tailscale (Private Domain)

on:
  workflow_dispatch:
    inputs:
      password:
        description: "HTTP Basic Auth password"
        required: true
        type: string
      custom_user:
        description: "Username"
        default: edgeuser
        type: string
      subdomain:
        description: "Subdomain (e.g. edge)"
        default: edge
        type: string

jobs:
  edge:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install & Authenticate Tailscale
        env:
          AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up \
            --authkey=$AUTHKEY \
            --accept-dns=false \
            --accept-routes \
            --advertise-exit-node \
            --hostname=github-edge-${{ github.run_id }}

          echo "Tailscale IP:"
          tailscale ip --4

      - name: Start MS Edge Container
        run: |
          docker run -d \
            --name msedge \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=Etc/UTC \
            -e CUSTOM_USER="${{ inputs.custom_user }}" \
            -e PASSWORD="${{ inputs.password }}" \
            -e HARDEN_DESKTOP=true \
            -e DISABLE_SUDO=true \
            -e DISABLE_TERMINALS=true \
            -p 3000:3000 \
            -v ${{ runner.temp }}/config:/config \
            --shm-size=1gb \
            lscr.io/linuxserver/msedge:latest

      - name: Wait for Edge
        run: |
          for i in {1..30}; do
            if docker logs msedge 2>&1 | grep -q "Selkies server listening"; then
              echo "Edge ready!"
              break
            fi
            sleep 5
          done

      - name: Enable Tailscale Funnel (HTTPS)
        run: |
          sleep 10
          until tailscale status > /dev/null 2>&1; do sleep 5; done
          TS_IP=$(tailscale ip --4 | head -n1)
          echo "Tailscale IP: $TS_IP"
          sudo tailscale funnel --bg --https=443:localhost:3000
          sleep 15

          echo ""
          echo "=================================="
          echo "   ACCESS: https://${{ inputs.subdomain }}.browser.tools"
          echo "   Username: ${{ inputs.custom_user }}"
          echo "   Password: [hidden]"
          echo "=================================="

      - name: Keep Alive
        run: sleep 21600
